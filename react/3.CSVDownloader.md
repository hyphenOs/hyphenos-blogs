# CSVDownloader Pattern

Hi,

Today we are going to learn a new pattern in our React series. It's called ***CSVDownloader Pattern***. This pattern implements an abstract common CSVDownloader Component that would convert our data(array of objects) into string and then make it available for download using Blob(we'll see it in details). While working on a project, a requirement of CSVDownloader in three components occured, which ended up in the form of this awesome pattern. We'll use our good'ol **Library App** with Books and Members sections for demonstration. So are you Ready for the ride? let's go then.

> #### What is CSV?
CSV (comma seperated values) is file format which stores tabular data in plain text format using comma to seperate values. In CSV file, Each line
is a data record and each data record has one more fields separated by comma.


> *"The IBM Fortran first supported CSV files in 1972"*
```
CSV Structure

A,B,C
1,2,3
4,5,6
```
> Library App Overview

In our *library* app we have two sections named Books and Members. Both will pass data(array of objects) to CSVDownloader

```javascript
<Books>
    <CSVDownloader data={this.props.books}>
</Books>
<Members>
    <CSVDownloader data={this.props.Members}>
</Members>
```

> CSVDownloader Implementation

CSVDownloader Component has following elements

-   `downloadCSV` function
    - `getCSVString` function
    - `getCSVBlob` function
    - `serveCSVBlob` function

> `downloadCSV` function

```javascript
<Button onClick={this.downloadCSV}>
    <CloudDownloadRounded />
    CSV
</Button>

downloadCSV = () => {
const arr = this.props.data;
const csvString = this.getCSVString(arr);
const csvBlob = this.getCSVBlob(csvString);
this.serveCSVBlob(csvBlob);
};

```
CSVDownloader Component contains a button that triggers download process on `onClick` by calling `downloadCSV` funcion.

`downloadCSV` gets `this.props.data` (array of objects) passed by parent component(Books or Members) as props and passes it to `getCSVString` function which returns it in string form(csvString). csvString is then passed to `getCSVBlob` function  to get a Blob which is then passed to `serveCSVBlob` function. `serveCSVBlob` serves it in browser for download purpose.


> `getCSVString` function

```javascript
getCSVString = arr => {
const csvArray = [Object.keys(arr[0])].concat(arr);

return csvArray
    .map(row => {
    return Object.values(row);
    })
    .join("\n");
};
```
`getCSVString` creates a csvArray containing array of csv headers and the arr object itself.

`map` method returns new array with array of header and subsequent array of values from each object by calling provided function on every element of csvArray. In short, we get an array containing headers and records

`join` function creates and returns csvString by concatenating all the elements in csvArray with new-line `\n`

> `getCSVBlob` function
```javascript
getCSVBlob = csvString => {
return new Blob([csvString], { type: "text/csv" });
};
```
It creates and returns **Blob** object of csvString with the help of constructor. It also passes `type: "text/csv" as MIME type

Well, but what exactly is Blob?

### ***Blob***

    new Blob(blobParts, options); //Blob constructor

    Example
    new Blob(["id,year\n1,2020"], {type: "text/csv"} )

    blobPart is an array of ArrayBuffer/String/Blob

    ArrayBuffer is an opaque representation of bytes in memory
    just as, Blob is an opaque representation of chunk of bytes/data

    options :
      1. type: MIME-type, eg. "text/csv"
      2. endings: whether to transform the end-of-line
         according to current OS. eg. "\r\n or \n"
          - transparent: do nothing
          - native: transform


Blob (Binary Large Object) is a data type which holds *"binary data with type"*. We can convert our files, images into binary data and store them as Blob. Blob represents file-like object of immutable, raw data. Being immutable, we can't change content of blob but we can create a new Blob using its slice method.


> `serveCSVBlob` function

```javascript
serveCSVBlob = csvBlob => {
const url = URL.createObjectURL(csvBlob);
console.log(url);

const link = document.createElement("a");
link.href = url;
link.setAttribute("download", "CSVData.csv");
document.body.appendChild(link);
link.click();
};
```

#### Blob as URL
`URL.createObjectURL(blob)` returns a unique url in the form `blob:<origin>/<uuid>`.
The generated URL is valid only for the current document, while it's open and can be referenced into `<img>` and `<a>`.
The generated URL is then set as `href` of `anchor` HTML element which is created using `createElement` function.
 The anchor element with its *download* attribute prompts user to save the linked url instead of navigating it. So, we'll set the *download* attribute with value of *CSVData.csv* as filename using `setAttribute`. The anchor element (link) will then be appended to document body using `appendChild`.
 Finally, we will simulate the mouse click on the anchor element(link) to download the csv file


 So, this was our ***CSVDownloader Pattern***. I hope it was a fine learning experience for you. We will meet again with another pattern in our next post.
Till then,

 Good Bye!


source code:

frontend (React): https://github.com/hyphenOs/library-frontend

backend (Django REST): https://github.com/hyphenOs/library-backend

Interested in interesting stuff?

check out https://hyphenos.io